<div class="container">
<h3 class=" text-center">Messaging</h3>
<div class="messaging">
<div class="inbox_msg">
  <div class="inbox_people">
    <div class="headind_srch">
      <div class="recent_heading">
        <h4>Recent</h4>
      </div>
      <div class="srch_bar">
        <div class="stylish-input-group">
          <%= form_tag( conversations_path, method: :get) do %>
            <%= text_field_tag :name,params[:name] , placeholder: "Search here"%>
            <span class="input-group-addon">
              <button type="button"><i class="fa fa-search" aria-hidden="true"></i></button>
            </span>
          <%end%>
        </div>
      </div>
    </div>
    <% if @conversations.blank? %>
        <div class="heading-holder">
        <h4 class="text-center" style="padding-top: 5%">No conversation found</h4>
        </div>  
    <% else %>
      <div class="inbox_chat">
        <% if current_user.buyers? %>
          <% @conversations.each do |conversation| %>
            <%= link_to conversation_path(conversation),method: "get" do %> 
              <div class="chat_list active_chat">
                <div class="chat_people">
                  <div class="chat_img">
                    <%= image_tag(conversation.sellers.check_avatar.present? ? conversation.sellers.check_avatar : 'avatar-placeholder-extra-small.png', alt: conversation.sellers.full_name) %>
                  </div>
                  <div class="chat_ib">
                    <h5><%= conversation.sellers.full_name %><span class="chat_date"><%= online_status conversation.sellers %></span></h5>
                    <p>I am Seller</p>
                  </div>
                </div>
              </div>
            <% end %>
          <% end %>
        <% elsif current_user.sellers? %>
          <% @conversations.each do |conversation| %>
            <%= link_to conversation_path(conversation),method: "get" do %> 
              <div class="chat_list active_chat">
                <div class="chat_people">
                  <div class="chat_img"> 
                    <%= image_tag(conversation.buyers.check_avatar.present? ? conversation.buyers.check_avatar : 'avatar-placeholder-extra-small.png', alt: conversation.buyers.full_name) %>
                  </div>
                  <div class="chat_ib">
                    <h5><%= conversation.buyers.full_name %><span class="chat_date"><%= online_status conversation.buyers %></span></h5>
                    <p>I am Buyer</p>
                  </div>
                </div>
              </div>
            <% end %>
          <% end %>
        <% end %>
      </div>
    <% end %>
  </div>
  <div class="mesgs">
    <% unless @conversation.blank? %>
      <div class="msg_history" id="messages" data-conversation-id="<%= @conversation.id %>">
      </div>
    <% end %>
    <div class="type_msg">
      <div class="input_msg_write">
        <% if !@conversation.blank? %>
          <%= form_for @chat,url: "#" do |f| %>
            <%= hidden_field_tag :user_id, current_user.id %> 
            <%= f.text_field :message, class: 'message-input write_msg', data: {emojiable: true } %>
            <div class="conversation-file-container"></div>
            <div class="image-upload" id="abc" >
              <label for="file-input">
                <i class="fa fa-paperclip"></i>
              </label>
              <%#= f.file_field :image,id: "file-input",class: "" %>
              <%= file_field_tag "conversation[image]", id: "file-input",data: { url: image_conversation_path(@conversation.id) } ,multiple: false %>
            </div>
            <%= button_tag(type: "submit", class: "msg_send_btn") do %>
              <i class="fa fa-paper-plane-o" aria-hidden="true"></i>
            <% end %>
          <% end %>
        <% end %>
      </div>
    </div>
  </div>
</div>

<% if @conversation.present? %>
  <script type="text/javascript">
    var current_conversation_id = <%= @conversation.id %>;
    var current_user_id = <%= current_user.id %>;
    var conversation_url = '<%= conversation_url(@conversation) %>';
    var chats_recipients = new Object();
    chats_recipients[<%= @conversation.seller_id %>] = {
      "name": "<%= (@conversation.seller_id == current_user.id) ? @conversation.sellers.full_name : @conversation.sellers.full_name %>",
      "image": "<%= image_path(@conversation.sellers.check_avatar.blank? ? 'avatar-placeholder-extra-small.png' : @conversation.sellers.check_avatar) %>"
    };
    chats_recipients[<%= @conversation.buyer_id %>] = {
      "name": "<%= (@conversation.buyer_id == current_user.id) ? @conversation.buyers.full_name : @conversation.buyers.full_name %>",
      "image": "<%= image_path(@conversation.buyers.check_avatar.blank? ? 'avatar-placeholder-extra-small.png' : @conversation.buyers.check_avatar) %>"
    };

  // $(function(){           
  //   $('.ratings .stars-rating').rating({ 
  //     callback: function(value){ 
  //       $.ajax({
  //         method: "POST",
  //         url: "/rating",
  //         data: {"rate": value,"seller_id": '<%= @conversation.seller_id %>'}
  //       }).done(function(response) {
  //         if(response.status){
  //           location.reload();
  //         }
  //       });
  //     } 
  //   });
  //   $('.rating-cancel').remove()
  // });
  $(function() {
    $('#file-input').fileupload({
        dataType: 'json',
        done: function (e, data) {
          $("#image-upload").attr("top","15%");
          $(".conversation-file-container").html('<div class="file-container"><img class= "thumb" src="'+data.result.file_path+'" /><a href="javascript:;" id="image-link" onclick="$(\'.conversation-file-container\').html(\'\')">X</a></div>');
        }
    });
  });
</script>
<% end %>
<style type="text/css">
  .online{
    width: 38px;
  }
</style>

<style type="text/css">
  body{margin-top:20px;}
  .comment-wrapper .panel-body {
    max-height:650px;
    overflow:auto;
  }
  .comment-wrapper .media-list .media img {
    width:64px;
    height:64px;
    border:2px solid #e5e7e8;
  }
  .comment-wrapper .media-list .media {
    border-bottom:1px dashed #efefef;
    margin-bottom:25px;
  }
  .image-upload > input{
    display: none;
  }
  .image-upload img{
    width: 80px;
    cursor: pointer;
  }
  .thumb{
    height: 100px;
    width: 100px;
  }
  #image-link{
    position: absolute;
    left: 96px;
    top: 36px;
  }

  #abc{
    height: 33px;
    position: absolute;
    right: 20px;
    top: 16px;
    width: 33px;
  }
</style>